input {
  http {
    host => "0.0.0.0"  
    port => 38383    
    codec => "json"
    ssl_enabled => true
    ssl_certificate => "/etc/logstash/logstash.crt"
    ssl_key => "/etc/logstash/logstash_rsa.key"
    tags => ["cf-http"]
  }
}

filter {
  if "cf-http" in [tags] {

    ruby {
      init => "require 'stringio'; require 'zlib'"
      code => '
        begin
          raw = event.get("message")
          if raw
            io = StringIO.new(raw)
            uncompressed = Zlib::GzipReader.new(io).read
            event.set("raw", uncompressed)
          end
        rescue
          event.tag("_gunzip_failed")
        end
      '
    }

    #sharon update
    if [raw] and !("_gunzip_failed" in [tags]) {
      mutate {
        replace => { "message" => "%{raw}" }
      }
    }

    if [message] {
      split {
        field => "message"
      }
    }

    split {
      field => "message"
    }

    json {
      source => "message"
    }

    if [EdgeStartTimestamp] {
      date {
        match  => ["[EdgeStartTimestamp]", "ISO8601"]
        target => "@timestamp"
      }
    }

    if ![ClientRequestReferer] { mutate { update => { "ClientRequestReferer" => "None" } } }
    if ![JA3Hash]              { mutate { update => { "JA3Hash"              => "None" } } }
    if ![JA4]                  { mutate { update => { "JA4"                  => "None" } } }
    if ![ClientXRequestedWith] { mutate { update => { "ClientXRequestedWith" => "None" } } }

		if [ClientRequestUserAgent] =~ /^Go-http-client\/2\.0$/ {
  		mutate {
    		replace => {
      		"Browsers" => "Unknown"
      		"Systems"  => "Unknown"
    		}
  		}
		} else {

      useragent {
        source => "ClientRequestUserAgent"
        target => "ua_data"
      }

      ruby {
        code => '
          os = event.get("[ua_data][os]")
          if os.is_a?(Hash)
            event.set("Systems", os["name"] || "Unknown")
          else
            s = os.to_s
            event.set("Systems", (s.empty? or ["Other","Unknown"].include?(s)) ? nil : s)
          end
          event.remove("ua_data")
        '
      }

      if ![Systems] or [Systems] == "" {
        grok {
          match => { "ClientRequestUserAgent" =>
            "(?i)(?<Systems>Windows|Linux|Macintosh|Android|iPhone)"
          }
        }
      }

      if [Browsers] == "Other" or [Browsers] == "Unknown" or ![Browsers] {
        if "Cloudflare-Traffic-Manager" in [ClientRequestUserAgent] {
          mutate { replace => { "Browsers" => "Cloudflare Bot" } }
        } else if "curl" in [ClientRequestUserAgent] {
          mutate { replace => { "Browsers" => "curl" } }
        } else if "python" in [ClientRequestUserAgent] {
          mutate { replace => { "Browsers" => "python" } }
        } else {
          mutate { replace => { "Browsers" => "Unknown" } }
        }
      }
    }

    geoip {
      source   => "ClientIP"
      target   => "geoip_client"
      database => "/etc/logstash/GeoLite2-City.mmdb"
    }

    geoip {
      source   => "OriginIP"
      target   => "geoip_origin"
      database => "/etc/logstash/GeoLite2-City.mmdb"
    }

    geoip {
      source   => "EdgeServerIP"
      target   => "geoip_edge"
      database => "/etc/logstash/GeoLite2-City.mmdb"
    }

    if ![geoip_client][country_name] and ![geoip_client][city_name] {
      mutate {
        add_field => {
          "[geoip_client][country_name]" => "Intranet"
          "[geoip_client][city_name]"    => "Intranet"
        }
      }
    }

    if [WAFAttackScore] {
      mutate {
        copy    => { "WAFAttackScore" => "WAFAttackScore_str" }
        convert => { "WAFAttackScore_str" => "string" }
      }

      translate {
        field            => "WAFAttackScore_str"
        destination      => "ThreatLevel"
        dictionary_path  => "/etc/logstash/cfwaf_score.yaml"
        fallback         => "Info"
      }

      mutate {
        remove_field => ["WAFAttackScore_str"]
      }
    }

    mutate {
      remove_field => ["message"]
    }
  }
}

output {
  if "cf-http" in [tags] {
    elasticsearch {
      hosts => ["https://localhost:9200"]
      user => "elastic"
      password => "twister%)&*4718"
      ssl_enabled => true
      ssl_verification_mode => "none"
      index => "across-cf-%{+YYYY.MM.dd}"
    }
    #file {
    #  path => "/tmp/cf-httplog.log"
    #  codec => "json_lines"
    #}
  }
}
